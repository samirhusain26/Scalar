# Scalar - Project Context

> **Maintenance rule**: When making significant changes (new files, new dependencies, architecture changes, new features), update this file to reflect those changes before committing.

## What Is This Project?
Scalar is a client-side deductive logic guessing game (similar to Wordle but with numerical attributes). Players guess entities (countries, chemical elements) and receive feedback via multiple logic systems — directional arrows, proximity tiers, geographic distance, category matching, and set intersection — to deduce the target. Features a "Total Moves" scoring system where players try to minimize their move count.

## Repository Layout
```
Scalar/                              # Git root
├── CLAUDE.md                        # THIS FILE - project context
├── README.md                        # Project documentation
├── GAMEPLAY.md                      # Detailed gameplay logic & scoring documentation
├── STYLE_GUIDE.md                   # Visual design system & component specifications
├── .gitignore
├── credentials.json                 # Google Service Account (DO NOT COMMIT - gitignored)
├── fetch_data.py                    # Python script: CSV files -> gameData.json
├── package.json                     # npm package (scalar, private)
├── package-lock.json
├── vite.config.ts                   # Vite build config (@ alias -> src/)
├── tsconfig.json                    # TypeScript root config (references app/node)
├── tsconfig.app.json                # App TS config (ES2022, strict)
├── tsconfig.node.json               # Node TS config (ES2023)
├── eslint.config.js                 # ESLint flat config (v9)
├── postcss.config.js                # PostCSS: @tailwindcss/postcss + autoprefixer
├── components.json                  # Shadcn CLI config
├── index.html                       # HTML entry point
├── data/                            # Source data files for game content
│   ├── countries_schema_config.csv  # Countries schema definition
│   ├── countries_enriched.csv       # Countries entity data
│   ├── elements_schema_config.csv   # Elements schema definition
│   ├── elements_enriched.csv        # Elements entity data
│   └── update_countries_csv.py      # One-off data update script for countries
└── src/                             # React/TypeScript source
    ├── main.tsx                     # Entry point: StrictMode, imports Geist Mono + Fraunces fonts + index.css
    ├── App.tsx                      # Root component: header, category selector, scoreboard, grid, input, modals
    ├── index.css                    # Tailwind v4 config + CSS custom properties + custom utilities
    ├── types.ts                     # All shared types: DataType, LogicType, DisplayFormat, UIColorLogic, SchemaField, Entity, Feedback, etc.
    ├── assets/
    │   └── data/gameData.json       # Static game data: schema definitions + entity data per category (auto-generated by fetch_data.py)
    ├── store/
    │   └── gameStore.ts             # Zustand store: single source of truth, localStorage persistence (version 13)
    ├── utils/
    │   ├── gameLogic.ts             # Pure functions: getFeedback (dispatch by logicType), checkWinCondition, etc.
    │   ├── feedbackColors.ts        # Shared color helpers: getGeoDistanceCellClass, getCategoryMatchClass, getStandardStatusClass, getCellColor
    │   ├── formatters.ts            # formatNumber(), formatDistance(), formatPercentageDiffTier(), formatYearDiffTier(), expandConservationStatus(), getDirectionSymbol(), getAlphaDirectionSymbol(), numberToLetter()
    │   ├── geo.ts                   # haversineDistance(): great-circle distance between coordinates
    │   ├── schemaParser.ts          # getDisplayColumns(), getFoldedColumns(), getVisibleCandidateColumns(), getFieldByKey()
    │   ├── challengeUtils.ts        # encodeChallenge(), decodeChallenge(): Base64 challenge URL encoding/decoding
    │   ├── analytics.ts             # trackGameEvent(): wrapper for Vercel Analytics event tracking
    │   └── cn.ts                    # cn(): clsx + tailwind-merge utility
    └── components/
        ├── ui/                      # Shadcn/UI primitives (button, card, dialog, input)
        ├── CategoryToggle.tsx       # Segmented button group for category selection (replaces <select>)
        ├── ColorLegend.tsx          # Persistent color legend strip (Exact/Hot/Near/Miss) above game grid
        ├── GameGrid.tsx             # Responsive card grid: CSS Grid, collapse state management, animated empty state, manages MajorHintModal
        ├── GuessCard.tsx            # Individual guess card: header, attribute grid, collapse/expand strip, expandable folded section, major-hint interactions
        ├── GameInput.tsx            # Autocomplete input: tag cloud suggestions, keyboard nav, onFocusChange for mobile header collapse
        ├── GameOverModal.tsx        # Radix Dialog: always centered, scrollable body with sticky header/footer. Category-specific entity card + Challenge + Play Again
        ├── HowToPlayModal.tsx       # Radix Dialog: gameplay instructions, auto-opens on first visit (localStorage: scalar-htp-seen)
        ├── MajorHintModal.tsx       # Radix Dialog: confirmation for hint reveal (free with credits, +3 moves without)
        ├── PrivacyPolicyModal.tsx   # Radix Dialog: privacy policy with Vercel Analytics disclosure
        ├── RevealAnswerModal.tsx    # Radix Dialog: always centered, shows ElementCellCard/CountryDetailCard on forfeit
        ├── ScalarLogo.tsx           # Venn diagram SVG logo component
        ├── VennBackground.tsx       # Animated decorative background SVG with venn diagram orbs
        ├── Scoreboard.tsx           # Header display: moves count + 3 free hint credit squares (no label)
        ├── CountryDetailCard.tsx    # "Passport-style" country card shown in GameOverModal/RevealAnswerModal
        └── ElementCellCard.tsx      # Periodic-table cell card shown in GameOverModal/RevealAnswerModal
```

## Tech Stack
- **React 19** with **TypeScript ~5.9** (strict mode, `noUnusedLocals`, `noUnusedParameters`)
- **Vite 7** for build/dev (`npm run dev` / `npm run build`)
- **Tailwind CSS v4** (uses `@theme inline` syntax in CSS, NOT `tailwind.config.js`)
- **Zustand 5** for state management with localStorage persistence
- **Shadcn/UI** (Radix UI primitives) for base components
- **Lucide React** for icons (Eye, Check, ChevronDown, Share2, X)
- **Vercel Analytics** (`@vercel/analytics`) for privacy-respecting usage analytics (no cookies, daily-reset hash)
- **Fraunces Variable** serif font for display headings (via `@fontsource-variable/fraunces`)
- **Geist Mono** for data, clues, and body text (monospace aesthetic)

## Key Commands
All commands run from repo root:
```bash
npm run dev       # Vite dev server at http://localhost:5173
npm run build     # tsc -b && vite build -> dist/
npm run lint      # ESLint (flat config, v9)
npm run preview   # Preview production build
```

Data fetch (reads CSVs from `data/`, writes `gameData.json`):
```bash
python fetch_data.py
```

## Architecture Pattern (Strict Separation of Concerns)
1. **Types** (`src/types.ts`) - All shared interfaces/types
2. **Pure Logic** (`src/utils/gameLogic.ts`) - Game mechanics as pure functions, NO state mutation
3. **State** (`src/store/gameStore.ts`) - Zustand store calls pure functions, updates state
4. **Components** (`src/components/`) - Consume state via `useGameStore`, render UI

**Data flow**: User action -> Component dispatches store action -> Store calls pure function from gameLogic -> Store updates state -> Components re-render -> localStorage persisted automatically

## Type System (`types.ts`)

### LogicType (how feedback is computed per field)
| LogicType | Purpose | Example Fields |
|-----------|---------|----------------|
| `EXACT_MATCH` | Binary exact equality | Landlocked?, Radioactive, Symbol matches name? |
| `CATEGORY_MATCH` | String match, optionally colored by distance gradient | Continent, Subregion, Phase (STP), Element Family, Block |
| `HIGHER_LOWER` | Numeric comparison with direction + percentage diff | Population, Area, Atomic #, Group, Period, Timezones |
| `GEO_DISTANCE` | Haversine distance between coordinates | Distance (virtual field in Countries) |
| `SET_INTERSECTION` | Intersection of comma-separated lists | Genre, Cast & Crew (when those categories are active) |
| `TARGET` | Entity name (identification only) | Country Name, Element |
| `NONE` | Support/hidden column (not displayed) | Latitude, Longitude, category bucket columns |

### DisplayFormat (how cell values render)
| Format | Rendering |
|--------|-----------|
| `HIDDEN` | Column not displayed in grid |
| `TEXT` | Raw string value |
| `DISTANCE` | Formatted km distance (e.g., "1,234 km") |
| `PERCENTAGE_DIFF` | Direction arrow + tier (e.g., "↑ ~25%") |
| `RELATIVE_PERCENTAGE` | Direction arrow + relative % (e.g., "↑ +34%") |
| `NUMBER` | Raw numeric value |
| `CURRENCY` | Direction arrow + $-prefixed value |
| `LIST` | Intersection count "X/Y" |
| `ALPHA_POSITION` | Letter character (1→A, 2→B, ..., 26→Z) with horizontal arrow direction |

### UIColorLogic (how cell background is determined)
| Logic | Coloring |
|-------|----------|
| `DISTANCE_GRADIENT` | Green if exact text match, white if miss (for location text fields like Continent/Subregion/Hemisphere) |
| `CATEGORY_MATCH` | Green if exact, gold if linked category matches, white if miss |
| `STANDARD` | Thermal EXACT/HOT/NEAR/MISS colors (green/orange/amber-dashed/white) |
| `NONE` | No special coloring |

### SchemaField Interface
```typescript
interface SchemaField {
    attributeKey: string;         // Column key in entity data
    displayLabel: string;         // Human-readable header label
    dataType: DataType;           // INT, FLOAT, STRING, CURRENCY, BOOLEAN, LIST
    logicType: LogicType;         // How feedback is computed
    displayFormat: DisplayFormat; // How the cell renders
    isFolded: boolean;            // Placed in expandable "More clues" section (no penalty)
    isVirtual: boolean;           // Computed field (e.g., distance_km)
    linkedCategoryCol?: string;   // Category column for HIGHER_LOWER status coloring
    uiColorLogic?: UIColorLogic;  // Override cell color logic
}
```

### Feedback Interface
```typescript
interface Feedback {
    direction: FeedbackDirection;     // UP, DOWN, EQUAL, NONE
    status: FeedbackStatus;           // EXACT, HOT, NEAR, MISS
    value: string | number | boolean; // Raw guess value
    displayValue?: string;            // Formatted display string
    distanceKm?: number;              // For GEO_DISTANCE / DISTANCE_GRADIENT
    percentageDiff?: number;          // For HIGHER_LOWER (symmetric ratio-based)
    categoryMatch?: boolean;          // For linked category coloring
    matchedItems?: { text: string; isMatch: boolean }[]; // For SET_INTERSECTION per-item match status
}
```

## Component Details

### App.tsx
- Derives `CATEGORIES` from `gameData.categories` keys (currently: `countries`, `elements`)
- Renders **sticky header** (`sticky top-0 z-40`, `bg-paper-white/95 backdrop-blur-sm`) with: `CategoryToggle` (left), GameInput (center), Scoreboard + `?` button (right)
- **Mobile layout**: stacked rows (CategoryToggle, input, scoreboard+HTP button), all centered; title area and category/score rows collapse (`max-h-0 opacity-0`) when input is focused
- **Desktop layout**: single row with absolutely centered input; header has `border-b-2 border-charcoal` (not venn gradient)
- **Mobile header**: `border-b-venn` gradient underline; title div animates to `h-0` on input focus
- `isInputFocused` state managed, passed to `<GameInput onFocusChange={setIsInputFocused} />`
- "How to Play" is a `?` icon button (`w-7 h-7 border border-charcoal`) with an orange pulse dot (`animate-pulse bg-thermal-orange rounded-full`) for new visitors (cleared when HTP modal is opened once)
- Win effect: briefly adds `invert` class to `<html>` on SOLVED status (200ms delay, 500ms invert)
- Answer section: `border-t-2 border-charcoal`, flex row on md. Shows `??????` while PLAYING, reveals **full name** (no truncation) when SOLVED/REVEALED. "Reveal Answer" button (bordered, not a link)
- **`ColorLegend`** rendered above `<GameGrid />` at all times
- **Footer**: "Built by Samir Husain" link (samirhusain.info) + "Privacy Policy" button opening PrivacyPolicyModal
- **Share button**: fixed bottom-right, **auto-hides** when scrolled down >10px (`translate-y-24`), reappears on scroll up, always visible when SOLVED. Uses Web Share API or clipboard.
- **Vercel Analytics**: `<Analytics debug={import.meta.env.DEV} />` component at root level

### GameGrid.tsx
- Responsive CSS Grid container: `grid-cols-1` (mobile), `md:grid-cols-2` (tablet), `xl:grid-cols-3` (desktop)
- Uses `getDisplayColumns()` from schemaParser to get visible fields
- Renders `GuessCard` components for each guess, most recent first (reversed order)
- **Collapse state management**: `collapsedByStableId` Map (keyed by stable guess index, never shifts). Auto-collapses the guess that slides into 4th position when a new guess is submitted; respects manual overrides. Map cleared on game reset.
- **Auto-collapse rule**: 3 most recent cards stay expanded; cards at position 4+ are auto-collapsed on the next submit.
- **Animated empty state**: "Make a Guess" heading (Fraunces serif, opacity-20) + bouncing arrow SVG with "Type above" label. Fades out (transition-opacity 300ms) then unmounts (350ms delay) when first guess arrives.
- Passes `collapsed`, `onToggleCollapse`, `isNew` props to each GuessCard
- Manages `MajorHintModal` confirmation state (pendingMajorHint accepts `string | string[]`)

### GuessCard.tsx
- Props: `guess`, `feedback`, `displayFields`, `majorHintAttributes`, `targetEntity`, `guessIndex`, `index`, `gameStatus`, `onRevealMajorHint`, `isNew`, `collapsed`, `onToggleCollapse`
- **`isNew`**: triggers `animate-card-enter` (slide down 16px + fade in, 0.25s ease-out)
- **Collapse/expand**: When `collapsed=true`, renders a **summary strip** — a row of colored squares (one per visible field: green=EXACT, orange=HOT, amber=NEAR, white=MISS) + ChevronDown, clickable to re-expand. When expanding from collapsed, body uses `card-body-enter` animation (max-height 0→800px, 0.2s).
- **Header**: Entity name (bold uppercase, left) + guess index `#03` format (right) + collapse chevron (mobile only, rotated 180° = pointing up)
- **Card opacity/scale**: idx=0 → 100%, idx=1 → 95%, idx≥2 → 85% opacity + `scale-[0.99]`
- **Main grid**: `grid grid-cols-2 gap-px bg-charcoal` — non-folded attributes with thin internal dividers
- **Merged Location cell**: Continent, Subregion, Hemisphere merged into a single col-span-2 row. Label: "Location". All exact = green bg. Partial = white bg with green text on matches, opacity-50 on misses. Hint reveals all 3 at once.
- **HIGHER_LOWER cells**: Split layout — value on left (`text-base font-bold`), arrow+tier on right (`renderSecondaryText` renders arrow larger than tier label). Year fields use year diff tiers (~5 yrs, ~15 yrs, etc.). ALPHA_POSITION renders A-Z letter with horizontal arrows only.
- **TruncatableText**: CATEGORY_MATCH cells >14 chars (subregion >16 chars) truncate with `…` and expand on tap/click.
- **List (SET_INTERSECTION)**: Full-width (col-span-2) rows. Per-item match coloring. Cast & Crew (`Credits` key) shows matched items only; hidden entirely if no matches.
- **N/A handling**: Missing values (-1, null, empty) render as "N/A" in gray italic on white bg.
- **Conservation status**: IUCN codes expanded to full labels via `expandConservationStatus()`
- **ALPHA_POSITION**: Numeric values (1-26) rendered as letters (A-Z) with horizontal arrows (←/→)
- **Scrabble score**: Displayed as "14 pts" or "14 pts · 2w" for multi-word names
- **Animal units**: `UNIT_MAP` — weight_kg → " kg", height_cm → " cm", lifespan_years → " yrs", speed_kmh → " km/h"
- **Olympics Hosted**: Merges hosted count with latest year in format "3 (2020)". Custom amber coloring when last years within 8 years.
- **Eye icon behavior**: Mobile — always visible at `opacity-50`. Desktop — hidden (`md:opacity-0`) until cell hover (`md:group-hover:opacity-70`), shows "Reveal" tooltip. Larger tap target: `w-7 h-7` button with `p-1.5`.
- **Hinted cells**: Show inverted target value badge (bg-charcoal text-paper-white, Check icon)
- **Expandable section**: Folded attributes (`isFolded: true`) in collapsible "More clues"/"Hide clues" section.
- Uses `getCellColor()` from `feedbackColors.ts` for all color logic
- Card aesthetic: `border border-charcoal bg-paper-white`, no shadows, no rounded corners
- `LIST_FIELD_KEYS = ['Credits', 'Genre']` — attribute keys for full-width list rows
- `LOCATION_KEYS = ['hemisphere', 'continent', 'subregion']` — merged into Location cell

### GameInput.tsx
- Autocomplete with downward-opening tag cloud suggestions (with small rotated-square caret)
- Keyboard navigation: ArrowUp/Down to navigate, Enter to select, Escape to close
- Disabled with "Solved" or "Revealed" placeholder when game is SOLVED or REVEALED
- Suggestions limited to 8 items, deduplicated by name
- Underline-style input: `border-0 border-b-2 border-b-charcoal`, no box, `bg-transparent`, `px-0`
- Width: `w-48 md:w-72 lg:w-80`
- `onFocusChange?: (focused: boolean) => void` prop — called on focus/blur to collapse mobile header rows
- On focus: `window.scrollTo({ top: 0, behavior: 'smooth' })`

### GameOverModal.tsx
- Radix Dialog — **always centered**, `w-[95vw] max-w-md`, `max-h-[85dvh] flex flex-col`
- Overlay click **can** close this modal (no `onInteractOutside` prevention)
- **Sticky header**: "Puzzle Complete" title (charcoal banner, Fraunces serif) + Close button (`<X>`)
- **Scrollable body**: `flex-1 overflow-y-auto p-4`
- **Sticky footer**: Challenge + Play Again buttons (`shrink-0 p-4 border-t border-charcoal/20`)
- **Category-specific entity display**:
  - `elements` → renders `<ElementCellCard>` (periodic table square with data panel)
  - `countries` → renders `<CountryDetailCard>` (passport-style card with data grid)
  - Other → entity name text (+ `targetEntity.image` if present)
- Shows total moves count (`text-3xl font-black X Moves`)
- **"Challenge a Friend"** button: generates challenge URL, shares "Can you beat my score of X moves?", uses Web Share API or clipboard; shows "Link Copied!" for 2s; tracks `challenge_shared` analytics event
- **"Play Again"** button: calls `onReset()`

### RevealAnswerModal.tsx
- Radix Dialog: **always centered** on all screen sizes (no bottom-sheet), `w-[95vw] max-w-sm md:max-w-md`
- Title: "Answer Revealed" (charcoal banner, Fraunces serif)
- **Category-specific entity display** (same as GameOverModal): `elements` → `<ElementCellCard variant="modal">`, `countries` → `<CountryDetailCard variant="modal">`, other → entity name
- Scrollable body: `overflow-y-auto max-h-[70vh] p-4`
- "New Game" button pinned to bottom (`border-t border-charcoal`)
- Tracks `game_forfeit` analytics event on open (once per open, via `hasFiredRef`)

### HowToPlayModal.tsx
- Auto-opens on first visit (localStorage key: `scalar-htp-seen`)
- Always centered, `w-[95vw] max-w-2xl`, `max-h-[85vh] flex flex-col`
- **Sticky header**: "How to Play" title (charcoal bg) + Close `<X>` button
- **Scrollable body**: `overflow-y-auto flex-1`
- Sections:
  1. **Intro** — left-border block: "A mystery entity is chosen at random. Guess to get clues..."
  2. **Reading a Guess Card** — mini example card (Brazil) showing: Location (partial match), Distance, Population (HOT ↑ ~5×), Landlocked (EXACT), Area (↓ ~50%), Govt. Type; with annotation swatches below
  3. **Cell Colors** — 4 thermal swatches (Exact/Hot/Near/Miss) in a 2×4 or 4-col grid
  4. **Direction & Proximity** — ↑/↓ arrow pills + `→ Later in alphabet` pill; proximity tier strip (~10% → ~100×) with gradient and "← Closer / Further →" labels
  5. **Scoring & Hints** — move costs table + hint credits row with credit squares + Eye icon description
- **"Got It" button** — inline at end of scrollable content (not a sticky footer)
- `SectionHeading` helper component for consistent section heading style

### MajorHintModal.tsx
- Confirmation dialog for hint reveal
- Shows dynamic cost: "free" if credits available (with count), "+3 moves" otherwise
- Buttons: Cancel, Reveal (Free) / Reveal (+3)
- Always centered, `max-w-sm`

### PrivacyPolicyModal.tsx
- Radix Dialog: always centered, `max-w-2xl`
- Sections: Information We Collect (local storage, Vercel Analytics), Information We Do Not Collect, Third-Party Services, Data Retention, Contact
- "Got It" close button, matches modal design system

### Scoreboard.tsx
- Inline in header
- Displays: "Moves" label + count (tabular-nums), graphite divider, 3 credit squares (filled if credit available, empty if spent) — **no "Hints" label**

### CountryDetailCard.tsx
- "Passport-style" country reveal card shown in GameOverModal when category is `countries`
- **Passport header**: country name (Fraunces serif `font-light`), location breadcrumb (Hemisphere • Continent • Subregion), capital city with ◉ prefix, ISO code watermark (top-right, large, 12% opacity)
- **Data grid**: 3-column grid with 14 fields: Area, Population, Pop. Density, GDP, GDP/Capita, Armed Forces, Landlocked?, Driving Side, Govt. Type, Timezones, Borders, Olympics Hosted, Last Olympics, UNESCO Sites
- Integer-verbatim fields (timezones, borders, olympics, unesco) shown as raw integers; `zeroAsDash` fields show "—" when 0

### ElementCellCard.tsx
- Periodic table cell card shown in GameOverModal when category is `elements`
- **Periodic table square**: Atomic # (top-left, `text-lg font-black`), Atomic Mass (top-right, `text-[11px]`), chemical Symbol (center, `text-7xl font-black`), element name (below, `text-xs uppercase tracking-[0.2em]`), Family · Block · Phase subtitle (`text-[10px]`)
- **Data panel**: 3-column grid with 17 fields (Group, Period, Year Discovered, Radioactive, Synthetic, Symbol matches name?, Classification, Rarity, Conductivity, Density, Electronegativity, Atomic Radius, Ionization Energy, Electron Affinity, Neutrons, Melt Point, Boil Point)
- `border-2 border-charcoal`, `max-w-[340px] mx-auto`

## Store (gameStore.ts)
```
State:
  activeCategory: string                  (default: 'countries')
  targetEntity: Entity                    (random on init/reset)
  guesses: GuessResult[]
  gameStatus: 'PLAYING' | 'SOLVED' | 'REVEALED'
  moves: number                           (total moves count, lower is better)
  credits: number                         (free hint credits, default: 3)
  majorHintAttributes: string[]           (tracks which attrs have been major-hinted)

Actions:
  setActiveCategory(cat) -> full reset: new target, clear guesses, reset moves/credits/hints
  submitGuess(entity) -> compute feedback, +1 move, check win; on SOLVED tracks game_completed via Vercel Analytics
  revealMajorHint(attr | attr[]) -> reveals exact target value; uses 1 credit if available (0 moves), else +3 moves
  revealAnswer() -> forfeit: status=REVEALED, moves=entity count in active category
  resetGame() -> new random target, clear guesses, keep category, reset moves=0 credits=3
  startChallengeGame(category, entity) -> set exact category+target for challenge URLs
```

Persisted to localStorage under key `scalar-game-storage` (**version 13** — bumping triggers migration that clears stale state).

**No `revealColumn` or `revealFoldedAttribute` actions** — all reveals go through `revealMajorHint`. Column visibility is always fully visible.

## Game Logic (gameLogic.ts) — Feedback Engine

The feedback system uses a **dispatch pattern** based on each field's `logicType`:

```
getFeedback(target, guess, schema)
  ├── Pre-computes haversine distance (for DISTANCE_GRADIENT fields)
  └── For each schema field (skipping TARGET and NONE):
      ├── EXACT_MATCH    → handleExactMatch()
      ├── CATEGORY_MATCH → handleCategoryMatch()
      ├── HIGHER_LOWER   → handleHigherLower()
      ├── GEO_DISTANCE   → handleGeoDistance()
      └── SET_INTERSECTION → handleSetIntersection()
```

### Handler Functions

| Handler | Logic | Status Rules |
|---------|-------|-------------|
| `handleExactMatch` | Binary equality (case-insensitive strings, boolean→Yes/No) | EXACT or MISS |
| `handleCategoryMatch` | String equality; attaches `distanceKm` when `uiColorLogic === 'DISTANCE_GRADIENT'` | EXACT or MISS |
| `handleHigherLower` | Numeric comparison; symmetric `percentageDiff` = (max/min − 1)×100; checks `linkedCategoryCol` for status; builds displayValue by `displayFormat` | EXACT (equal), HOT (linked category matches), MISS |
| `handleGeoDistance` | Pre-computed haversine distance in km | EXACT (0km), HOT (<1000km), NEAR (<3000km), MISS (≥3000km) |
| `handleSetIntersection` | Comma-separated list intersection-over-union ratio | EXACT (1.0), HOT (>0.5), NEAR (>0), MISS (0) |

### Supporting Utilities

**feedbackColors.ts:**
| Function | Purpose |
|----------|---------|
| `getGeoDistanceCellClass(distanceKm)` | green (<1000km), amber (<3000km), yellow (<5000km), white (≥5000km) |
| `getCategoryMatchClass(categoryMatch)` | `bg-cat-match` (gold) or `bg-white text-charcoal` |
| `getStandardStatusClass(status)` | green (EXACT), orange (HOT), amber-dashed (NEAR), white (MISS) |
| `getCellColor(feedback, field)` | Composite dispatcher by `uiColorLogic` and feedback |

**formatters.ts — Tier Labels:**
| Function | Output tiers |
|----------|-------------|
| `formatPercentageDiffTier(percentDiff)` | Exact → ~10% → ~25% → ~50% → **~2× → ~5× → ~10× → ~50× → ~100×** |
| `formatYearDiffTier(absDiff)` | Exact → **~5 yrs → ~15 yrs → ~30 yrs → 30+ yrs** |

**Other utilities:** `formatNumber()`, `formatDistance()`, `expandConservationStatus()`, `getDirectionSymbol()`, `getAlphaDirectionSymbol()`, `numberToLetter()`

**challengeUtils.ts:** `encodeChallenge(categoryId, entityId)` / `decodeChallenge(hash)` — Base64 `{c, i}` JSON

**analytics.ts:** `trackGameEvent(name, data)` — tracks `game_completed` (category, moves, used_hints), `challenge_shared` (category, moves), and `game_forfeit` (category)

**geo.ts:** `haversineDistance(lat1, lon1, lat2, lon2)` — great-circle km

**schemaParser.ts:** `getDisplayColumns()`, `getFoldedColumns()`, `getVisibleCandidateColumns()`, `getFieldByKey()`

## Scoring System (Total Moves)
- **+1 move** per guess submitted
- **Hints** (Eye icon on any attribute): Free if credits > 0 (consumes 1 credit), else **+3 moves**
- **Free hint credits**: 3 per game (displayed as filled squares in Scoreboard)
- **Forfeit**: Reveal Answer ends game as REVEALED, moves set to total entity count in active category

## Hint System
All non-folded display columns are visible by default. The only hint mechanism is the **Eye icon** (triggers `revealMajorHint`).

- Eye icon on ALL cells, top-right corner (`w-7 h-7` button, `p-1.5` tap target)
- Mobile: always visible at `opacity-50`. Desktop: hidden (`md:opacity-0`) until cell hover, shows "Reveal" tooltip
- Only visible while PLAYING
- Clicking opens MajorHintModal for confirmation + cost display
- Location cell hint reveals all 3 location attributes at once for a single credit/cost
- Once revealed: inverted badge (bg-charcoal text-paper-white + Check icon) shows target value
- Hint state persisted in `majorHintAttributes` array in store

### Folded Attributes
- Schema fields with `isFolded: true` appear in a collapsible "More clues" section
- **Currently: neither active category (countries, elements) has folded fields** — the section never renders
- Folded reveals would use the same revealMajorHint credit/moves logic

## Design System Rules
- **"Thermal E-Paper / Scientific Journal"** aesthetic
- Background: `#FAFAF9` (paper-white), Foreground: `#18181B` (charcoal), Structural borders: `#E2E8F0` (graphite)
- **Sharp corners** (`--radius: 0px`), thin 1px borders
- **Typography**: Fraunces Variable serif (`font-serif-display`) for headings, Geist Mono for everything else
- **Thermal feedback**: EXACT=green (#22C55E), HOT=orange (#F97316), NEAR=amber-dashed, MISS=white
- **GEO_DISTANCE**: green (<1000km) → amber (<3000km) → yellow (<5000km) → white (≥5000km)
- **DISTANCE_GRADIENT**: green (exact text match) / white (miss) — binary
- **Category match**: green (exact) / gold (bucket match) / white (miss)
- **Hard-edge shadows**: `shadow-hard` (6×6px), `shadow-hard-sm` (4×4px) — no blurs
- **Buttons**: invert on hover; **Input**: underline-style (bottom border only)

## CSS Custom Utilities (index.css)
```
bg-geo-warm          — #F59E0B (Amber), charcoal text — distance <3000km
bg-geo-yellow        — #FACC15 (Yellow), charcoal text — distance <5000km
bg-cat-match         — #EAB308 (Gold), charcoal text — category bucket match
font-serif-display   — Fraunces Variable serif
shadow-hard          — 6px 6px hard-edge shadow (modals)
shadow-hard-sm       — 4px 4px hard-edge shadow (dropdowns)
border-b-venn        — teal→gold→pink gradient underline (mobile header)
animate-glow         — subtle gold box-shadow pulse (2s loop)
.animate-card-enter  — new guess slide-in (translateY -16px→0, opacity 0→1, 0.25s)
.card-body-enter     — expand-from-collapsed animation (max-height 0→800px, 0.2s)
.animate-bounce-up   — empty-state arrow bounce (translateY oscillation, 2s loop)
```

## Tailwind Color Tokens (`@theme inline`)
```
paper-white: #FAFAF9   charcoal: #18181B    graphite: #E2E8F0
thermal-green: #22C55E thermal-orange: #F97316
```
Note: `thermal-amber` (`#F59E0B`), `thermal-gold` (`#EAB308`), geo-distance colors, and category match colors are implemented as `@utility` classes (not Tailwind tokens) in index.css.

## Data Pipeline

### CATEGORY_MAP (fetch_data.py — currently active)
```python
CATEGORY_MAP = {
    "countries": {
        "schema": "countries_schema_config.csv",
        "data":   "countries_enriched.csv",
    },
    "elements": {
        "schema": "elements_schema_config.csv",
        "data":   "elements_enriched.csv",
    },
}
```

### Adding a New Category
1. Create `data/{category}_schema_config.csv`
2. Create `data/{category}_enriched.csv`
3. Add entry to `CATEGORY_MAP` in `fetch_data.py`
4. Run `python fetch_data.py`
5. UI auto-discovers — no component code changes needed (consider adding a category-specific win card to GameOverModal)

## Category Schemas

### Countries
Active (visible in game grid) — no folded fields:

| Attribute | Logic Type | Display Format | Notes |
|-----------|-----------|----------------|-------|
| Continent | CATEGORY_MATCH | TEXT | `uiColorLogic: DISTANCE_GRADIENT` (green/white binary) |
| Subregion | CATEGORY_MATCH | TEXT | `uiColorLogic: DISTANCE_GRADIENT` |
| Hemisphere | CATEGORY_MATCH | TEXT | `uiColorLogic: DISTANCE_GRADIENT` |
| Distance from Target | GEO_DISTANCE | DISTANCE | Virtual field, haversine km between capitals |
| Area (sq km) | HIGHER_LOWER | PERCENTAGE_DIFF | Linked to area_cat |
| Population | HIGHER_LOWER | PERCENTAGE_DIFF | Linked to population_cat |
| Landlocked? | EXACT_MATCH | TEXT | Yes/No |
| Govt. Type | CATEGORY_MATCH | TEXT | government_type |
| Borders | HIGHER_LOWER | NUMBER | border_countries_count |
| Timezones | HIGHER_LOWER | NUMBER | Linked to timezone_cat |
| 1st Letter | HIGHER_LOWER | ALPHA_POSITION | first_letter (1-26 → A-Z with ←/→) |

Hidden/inactive: gdp_per_capita, Armed Forces, driving_side, pop_density, olympics_hosted_count, olympics_latest_year, GDP, unesco_sites, and all `*_cat` support columns.

### Elements
Active (visible in game grid) — no folded fields:

| Attribute | Logic Type | Display Format | Notes |
|-----------|-----------|----------------|-------|
| Atomic # | HIGHER_LOWER | NUMBER | AtomicNumber |
| Group | HIGHER_LOWER | NUMBER | Linked to GroupBlock |
| Period | HIGHER_LOWER | NUMBER | |
| Phase (STP) | CATEGORY_MATCH | TEXT | StandardState: Solid, Liquid, Gas |
| Element Family | CATEGORY_MATCH | TEXT | element_family |
| Block | CATEGORY_MATCH | TEXT | s/p/d/f block |
| Radioactive | EXACT_MATCH | TEXT | is_radioactive; Yes/No |
| Symbol matches name? | EXACT_MATCH | TEXT | symbol_match; Yes/No |

Hidden (HIDDEN display format — not shown in game grid, shown in ElementCellCard on win): AtomicMass, Density, MeltingPoint, BoilingPoint, Electronegativity, AtomicRadius, IonizationEnergy, ElectronAffinity, rarity_category, YearDiscovered, is_synthetic, neutron_count, conductivity_type, broad_classification.

## Important Gotchas
- `credentials.json` is gitignored - needed only for legacy Google Sheets access
- No test framework configured - `gameLogic.ts` pure functions are the best candidates for unit tests
- localStorage keys: `scalar-game-storage` (game state, **version 13**), `scalar-htp-seen` (HTP modal)
- **Store version is 13** — bumping triggers migration that clears stale localStorage
- No difficulty modes — single difficulty with Total Moves scoring
- Game status flow: PLAYING → SOLVED (win) or PLAYING → REVEALED (forfeit)
- `linkedCategoryCol` fields (logicType: NONE, displayFormat: HIDDEN) drive HIGHER_LOWER status coloring
- Virtual fields (`isVirtual: true`) like `distance_km` are computed at feedback time, not stored in entity data
- **No `revealColumn` or `revealFoldedAttribute`** actions — all hints use `revealMajorHint`
- **Neither active category has folded fields** — "More clues" section never renders currently
- Percentage diff uses **symmetric ratio** (max/min − 1) — both UP and DOWN give same tier magnitude
- Year diff tiers: ~5 yrs, ~15 yrs, ~30 yrs, 30+ yrs (not the old ±2/±5/±10 scale)
- `revealAnswer()` sets moves to **entity count** of the active category (not infinity/∞)
- GameOverModal **can** be dismissed by clicking the overlay (no `onInteractOutside` prevention)

## Game Concepts Reference
- **Categories**: `countries`, `elements` (auto-discovered from `gameData.json`)
- **Logic types**: EXACT_MATCH, CATEGORY_MATCH, HIGHER_LOWER, GEO_DISTANCE, SET_INTERSECTION, TARGET, NONE
- **Feedback statuses**: EXACT, HOT, NEAR, MISS
- **Feedback directions**: UP (target higher), DOWN (target lower), EQUAL, NONE
- **Hints**: Eye icon on any cell → revealMajorHint → free (credit) or +3 moves
- **Challenge Mode**: `?challenge=` query param, Base64 `{c, i}` JSON, decoded on mount, triggers `startChallengeGame`
- **Win condition**: All feedback fields EXACT
- **Forfeit**: REVEALED state, moves = entity count in category
- **Game Over**: Always-centered modal with category-specific entity card (ElementCellCard / CountryDetailCard)
- **Share**: Fixed "Share" button (bottom-right) for challenge URLs; "Challenge a Friend" in GameOverModal also generates challenge link

## Common Task Patterns

### Adding a new game mechanic
1. Add pure function to `src/utils/gameLogic.ts`
2. Add state/action to `src/store/gameStore.ts`
3. Consume new state in the relevant component

### Adding a new category
1. Create `data/{category}_schema_config.csv`
2. Create `data/{category}_enriched.csv`
3. Add to `CATEGORY_MAP` in `fetch_data.py`
4. Run `python fetch_data.py`
5. UI auto-discovers — optionally add a category-specific win card to GameOverModal

### Adding a new logic type
1. Add to `LogicType` union in `src/types.ts`
2. Create handler in `src/utils/gameLogic.ts`, add case to `getFeedback()`
3. Update `feedbackColors.ts` if new coloring needed
4. Update `GuessCard.tsx` if new cell rendering needed
5. Add CSS utilities to `src/index.css` if needed

### Modifying scoring
- `HINT_MOVE_COST = 3`, `DEFAULT_CREDITS = 3` in `gameStore.ts`
- Each guess adds +1 move in `submitGuess`
